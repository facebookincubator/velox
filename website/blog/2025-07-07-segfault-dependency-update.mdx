---
slug: segfault-dependency-update
title: "SEGFAULT due to Dependency Update"
authors: [majetideepak, czentgr]
tags: [tech-blog, build]
---

## Background
Velox depends on a number of [libraries](https://github.com/facebookincubator/velox/blob/main/CMake/resolve_dependency_modules/README.md).
Some of these libraries include other open-source libraries from Meta including [folly](https://github.com/facebook/folly) and
[fbthrift](https://github.com/facebook/fbthrift). These libraries are in active development. These libraries also depend on each other and hence
they all have to be updated at the same time to the same version.

Updating these dependencies usually involves fixing the Velox code to align with any public API changes or semantic changes.
However, a recent upgrade of folly and fbthrift to version *v2025.04.28.00* caused a *SEGFAULT* only in one unit test in Velox
named *velox_functions_remote_client_test*.

## Investigation
We immediately put on our *gdb* gloves and looked at the stack traces. This issue was reproducible in a debug build as well.
The SEGFAULT was due to invoking a destructor of a certain handler.
However, the corresponding source code was pointing to an invocation of a different function. And this code was present inside a fbthrift
header called *AsyncProcessor.h*
This handler(*RemoteServer*) was implemented in Velox as a thrift definition. Velox compiled this thrift file using fbthrift and the generated code
was using the *ServerInterface* class in fbthrift. This *ServerInterface* class was further extended from the *AsyncProcessorFactory* and
*ServiceHandlerBase* interfaces in fbthrift.
One of the culprits in the past was the conflict due to the usage of Apache thrift and fbthrift. However, this was not root cause this time as we were
able to reproduce this issue by just building the test without the Apache thrift dependency installed.
We were entering a new teritorry to investigate and we were not sure where to start.

We then compiled an example called *EchoService* in fbthrift that was very similar to the *RemoteServer* and it worked. Then we copied the *RemoveServer*
to fbthrift and that worked too! So the cuplrit was likely in the compilation flags which likely differed between fbthrift and Velox.
We enabled the verbose logging for both the builds and were able to spot one difference. We saw *-fcoroutines* being used in the fbthrift build.

We were also very curious about the invocation of the destructor instead of the actual function. We wore the gdb gloves again and dumped the entire
vtable for the RemoteServer class and its base classes. The vtables were different when it was built in Velox vs fbthrift.

vtable in the Velox build had the following entires:

```
folly::SemiFuture<folly::Unit> semifuture_onStartServing()
folly::SemiFuture<folly::Unit> semifuture_onStopRequested()
Thunk ServiceHandlerBase::~ServiceHandlerBase
Thunk ServiceHandlerBase::~ServiceHandlerBase
```

vtable in the fbthrift build had the following entires:

```
folly::coro::Task<void> co_onStartServing()
folly::coro::Task<void> co_onStopRequested()
folly::SemiFuture<folly::Unit> semifuture_onStartServing()
folly::SemiFuture<folly::Unit> semifuture_onStopRequested()
Thunk ServiceHandlerBase::~ServiceHandlerBase
Thunk ServiceHandlerBase::~ServiceHandlerBase
```

Tying up both the pieces of evidence, we could conclude that Velox was seeing a different vtable structure compared to what fbthrift was built with.
Looking around further, we noticed that the *ServiceHandlerBase* was conditionally adding functions based on the *-fcoroutines* flag.

```
class ServiceHandlerBase {
  ....
 public:
#if FOLLY_HAS_COROUTINES
  virtual folly::coro::Task<void> co_onStartServing() { co_return; }
  virtual folly::coro::Task<void> co_onStopRequested() {
    throw MethodNotImplemented();
  }
#endif

  virtual folly::SemiFuture<folly::Unit> semifuture_onStartServing() {
#if FOLLY_HAS_COROUTINES
    return co_onStartServing().semi();
#else
    return folly::makeSemiFuture();
#endif
  }
```

We recompiled fbthrift in Velox with coroutines disabled and the test passed.
