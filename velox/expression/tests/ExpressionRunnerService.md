# ExpressionRunnerService

This service provides a HTTP interface to the ExpressionRunner functionality, allowing you to run SQL expressions on input data via network requests instead of command line arguments.

## Building the Service

To build the ExpressionRunnerService, use the following command:

```bash
buck build //velox/expression/tests:velox_expression_runner_service
```

## Running the Service

After building, you can run the service with:

```bash
./buck-out/gen/velox/expression/tests/velox_expression_runner_service
```

By default, the service listens on port 8080. You can change this using the `--port` flag:

```bash
./buck-out/gen/velox/expression/tests/velox_expression_runner_service --port 9090
```

### Available Command Line Options

- `--port`: Port to listen on (default: 8080)
- `--registry`: Function registry to use for expression evaluation. Options are "presto" (default) or "spark"
- `--mode`: Mode for expression runner. Options are:
  - `verify`: Evaluate the expression and compare results between common and simplified paths
  - `common`: Evaluate the expression using common path and print out results (default)
  - `simplified`: Evaluate the expression using simplified path and print out results
  - `query`: Evaluate SQL query and print out results
- `--use_seperate_memory_pool_for_input_vector`: If true (default), expression evaluator and input vectors use different memory pools
- `--fuzzer_repro_path`: Directory path where all input files generated by ExpressionVerifier are expected to reside

## Using the Service

You can send HTTP POST requests to the service with JSON payloads containing the parameters for the ExpressionRunner.

### Example Request

```bash
curl -X POST http://127.0.0.1:8080 \
  -H "Content-Type: application/json" \
  -d '{
    "fuzzer_repro_path": "/path/to/fuzzer/repro/directory",
    "num_rows": 100,
    "store_result_path": "/path/to/store/results"
  }'
```

### Request Parameters

- `fuzzer_repro_path`: (required) Directory path where all input files generated by ExpressionVerifier are expected to reside
- `num_rows`: (optional) Maximum number of rows to process (0 means all rows)
- `store_result_path`: (optional) Path to store results

The service will look for the following files in the `fuzzer_repro_path` directory:
- Input vector files with prefix `input_vector_`
- Input selectivity vector files with prefix `input_selectivity_vector_`
- SQL expression file named `expression.sql`
- Result vector file named `result_vector.bin`
- Input row metadata file named `input_row_metadata.bin`
- Complex constants file named `complex_constants.bin`

### Example Response

```json
{
  "status": "success",
  "output": "Row(a:INTEGER, b:VARCHAR)\n1\ta\n2\tb\n3\tc\n"
}
```

If there's an error, the response will look like:

```json
{
  "status": "error",
  "message": "Error message details"
}
```

## Converting from Command Line to HTTP Request

If you previously used the ExpressionRunnerTest with command line arguments, you can convert them to a JSON request for the service. For example:

Command line:
```bash
./expression_runner_test --fuzzer_repro_path=/path/to/fuzzer/repro/directory --mode=common
```

Equivalent HTTP request:
```json
{
  "fuzzer_repro_path": "/path/to/fuzzer/repro/directory"
}
```

Note that the `mode` parameter is set via command line when starting the service, not in the request payload.
